#!/bin/bash

app=$1
regen="${@: -1}"
args="${@:2}"

# 1>&2 (stderr)
# 1>&3 (console)
# | tee /dev/fd/3 (both console and log)

export LOG_FILE=results.log
export JAVA_OPTS="-Xmx512m"
export _JAVA_OPTIONS="-Xms1024m -Xmx64G -Xss256m"

timestemp=$(date +"%c")
#exec 3>&1 1>>${LOG_FILE} 2>&1

echo $app

if [ $regen = true ]; then
	rm -rf gen/$app
	mkdir gen/$app
	bin/spatial $app --synth 2>&1 | tee gen/$app/spatial-build.log
fi

## VCS build
cd gen/$app/

if [ $regen = true ]; then
	make vcs 2>&1 | tee vcs-build.log
  echo $args > args
fi


## Sim Start
#chmod u+wrx run.sh
#./run.sh $args 2>&1 | tee sim.log
#cycle=$(grep "Design ran for" sim.log)
#pass=$(grep "PASS" sim.log)
#
#cd ../../
#echo "$timestemp $app $cycle args=[$args] $pass" >> $LOG_FILE 
#echo "$timestemp $app $cycle args=[$args] $pass"
#
##trap "trap - SIGTERM && kill -- -$$" SIGINT SIGTERM EXIT
